#!/bin/sh
# post-commit hook: 提交后自动更新CHANGELOG
# 注意: 仅在非amend操作时执行，避免死循环

# 检查是否是amend操作
if git diff --cached --name-only | grep -q .; then
  exit 0
fi

echo "📝 正在更新CHANGELOG.md..."

# 使用conventional-changelog更新CHANGELOG
if command -v npx &> /dev/null; then
  npx conventional-changelog -p angular -i CHANGELOG.md -s -r 0 2>/dev/null
  
  if [ $? -eq 0 ]; then
    # 检查CHANGELOG是否有变化
    if git diff CHANGELOG.md | grep -q .; then
      echo "✅ CHANGELOG.md已更新"
      git add CHANGELOG.md
      git commit --amend --no-edit --no-verify 2>/dev/null
      echo "✅ CHANGELOG已合并到当前提交"
    fi
  fi
fi

exit 0
