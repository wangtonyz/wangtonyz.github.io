#!/bin/sh
# pre-push hook: éªŒè¯commitæ¶ˆæ¯æ ¼å¼å’Œæ›´æ–°CHANGELOG
echo "ğŸ” æ£€æŸ¥commitæ¶ˆæ¯æ ¼å¼..."

# è·å–æœ€åä¸€æ¡commitæ¶ˆæ¯
COMMIT_MSG=$(git log -1 --pretty=%B)

# æ£€æŸ¥commitæ¶ˆæ¯æ˜¯å¦ç¬¦åˆConventional Commitsæ ¼å¼
if ! echo "$COMMIT_MSG" | grep -qE '^(feat|fix|docs|style|refactor|perf|test|chore|ci)(\(.+\))?:'; then
  echo "âŒ Commitæ¶ˆæ¯æ ¼å¼ä¸ç¬¦åˆè§„èŒƒï¼"
  echo "è¯·ä½¿ç”¨ä»¥ä¸‹æ ¼å¼ï¼š"
  echo "  feat(scope): æ–°åŠŸèƒ½æè¿°"
  echo "  fix(scope): ä¿®å¤bugæè¿°"
  echo "  docs: æ–‡æ¡£å˜åŒ–"
  echo "  style: ä»£ç é£æ ¼å˜åŒ–"
  echo "  refactor: ä»£ç é‡æ„"
  echo "  perf: æ€§èƒ½ä¼˜åŒ–"
  echo "  test: æ·»åŠ æµ‹è¯•"
  echo "  chore: æ„å»ºæˆ–ä¾èµ–å˜åŒ–"
  echo "  ci: CIé…ç½®å˜åŒ–"
  exit 1
fi

echo "âœ… Commitæ¶ˆæ¯æ ¼å¼æ­£ç¡®"

# æ£€æŸ¥æ˜¯å¦å­˜åœ¨CHANGELOG.mdï¼Œå¦‚æœä¸å­˜åœ¨åˆ™åˆ›å»º
if [ ! -f "CHANGELOG.md" ]; then
  echo "ğŸ“ åˆ›å»ºCHANGELOG.md..."
  > CHANGELOG.md
fi

echo "ğŸ“ æ›´æ–°CHANGELOG.md..."

# ä½¿ç”¨conventional-changelogæ›´æ–°CHANGELOG
if command -v npx &> /dev/null; then
  npx conventional-changelog -p angular -i CHANGELOG.md -s -r 0 2>/dev/null
  
  if [ $? -eq 0 ]; then
    echo "âœ… CHANGELOG.mdå·²è‡ªåŠ¨æ›´æ–°"
    # å¦‚æœCHANGELOGæœ‰æ”¹åŠ¨ï¼Œæ·»åŠ åˆ°staging
    if git diff CHANGELOG.md | grep -q .; then
      git add CHANGELOG.md
      echo "âœ… CHANGELOG.mdå·²åŠ å…¥åˆ°æœ¬æ¬¡push"
    fi
  fi
fi

echo "âœ… pushå‰æ£€æŸ¥å®Œæˆï¼Œç»§ç»­æäº¤..."
exit 0
